Resource 1:

1. Clear Specify Role and Responsibility 
  You are a database engineer. Create a syntactically correct Snowflake query for the given input.

2. Specify Tables and Columns Definition
  This is the most important part of the prompt as columns definition will help foundational model understand the user question and relate to correct columns. Be as descriptive as possible.

      Table definition:
      - Table Name: ECOMMERCE_SCHM.PRODUCTS
      - Columns
          product_name - the name of the product
          product_category – Main category of the product
          product_category_tree - Main category and subcategory under which the product belongs like Jewellery >> Necklaces & Chains >> Necklace, Jewellery >> Rings
          pid – primary key to identify product
          retail_price – Retail price of the product
          discounted_price – Discounted price of the product
          image – url of product image
          is_advantage_product – CHAR(1) - A flag to indicate if product is an yes. Y means Yes and N means No. 
          product_rating – Integer - product rating from 0 to 5
          overall_rating - Integer – overall product rank in its category
          brand – brand of the product
          product_specifications – Specification of product like size, weight, colors etc
          availability_country_code - 2 character customer country code. Use ISO alpha-2 code for customer country codes in the filter for country code. Use GB for United Kingdom.

3. Mention possible domain values for the columns
    
    product_category - Home, Jewellery, Books, Shoes, Clothes, Furniture
    is_advantage_product - Y, N

4. Mention the rules to be followed
    Rules:
    Ensure that the SQL query is concise and do not repeat the column names.
    To limit result set use 'LIMIT'. Never use the term "TOP" to limit result set.
    Do not add quotes for the column alias.
    Use SELECT DISTINCT to avoid duplicates.
    Use 2 character ISO country codes in the filter for country code. 
    If not asked in the question, do not limit the data.
    If there is a month or quarter filter, do include year and month filters.
    Use like operator to match customer names in the filter.
    Use upper function for columns in where clause to match the filter values. 
    Do not miss possible product names from the question. 
    Strictly use only domain values in filters for these columns: product_category 

5. Output format - A standardized format for the generated output should be implemented to facilitate seamless integration and execution within downstream applications, ensuring compatibility and efficiency.

    Format the generated SQL output as follows.
    Question:
    SQL: 
    Done:"Stop here"

6. Providing Illustrative Examples
    This important section of the prompt allows you to determine the information to be included. The Enterprise users expect their application to be built as per requirements and system should give right information, without them specifying every time.
    A text-to-sql prompt works well with 3-5(max) examples. Try to find the patterns in questions like user is asking for details level or aggregate levels. Create examples based on these patterns and keep it consistent.
    Secondly try to use maximum columns across examples. Diverse query patterns and leveraging multiple columns increases user question understanding and better SQL accuracy.
    Thirdly, do not forget to use the output format in the examples also.

    Example 1
    Question: Show me all available rings in India.
    SQL: Select pid product_name, product_category, product_category_tree, retail_price, discounted_price from ECOMMERCE_SCHM.PRODUCTS where UPPER(product_category) like ‘%RINGS%’ and availability_country_code = ‘IN’
    Done:"Stop here"
    
    Note that country code is mentioned in to 2 letter ISO format
    
    Example 2
    Question: Show me top 10 furniture items with highest discounts 
    SQL: Select product_name, (retail_price  - discounted_price)*100/ retail_price as discount_percent from ECOMMERCE_SCHM.PRODUCTS where UPPER(product_category) like ‘%FURNITURE%’ order by discount_percent desc LIMIT 10
    Done:"Stop here"
    
    Example 3
    Question: Summarize the total advantageous products by category with a 4-star rating and above.
    SQL: Select product_category, count (1) as Total_products, avg(overall_rating) as avg_rating from ECOMMERCE_SCHM.PRODUCTS where is_Advantage_product = ‘Y’ 
    group by product_category
    having avg_rating >= 4
    Done:"Stop here" 


Resource 2:  https://medium.com/firebird-technologies/building-a-reliable-text-to-sql-pipeline-a-step-by-step-guide-pt-1-9041b0777a77

https://miro.medium.com/v2/resize:fit:4800/format:webp/1*LBSQXLofIiu5hJvB-BMs9A.png

db_info = """### Database Structure:

**Tables:**
1. **salesperson**
   - `salesperson_id` (INT)
   - `name` (TEXT)
   - `region` (TEXT)
   
   **Sample Data**:
   | salesperson_id | name        | region |
   |----------------|-------------|--------|
   | 1              | John Doe    | North  |
   | 2              | Jane Smith  | South  |

2. **timber_sales**
   - `sales_id` (INT)
   - `salesperson_id` (INT, FK to `salesperson`)
   - `volume` (REAL)
   - `sale_date` (DATE)

   **Sample Data**:
   | sales_id | salesperson_id | volume | sale_date  |
   |----------|----------------|--------|------------|
   | 1        | 1              | 120    | 2021-01-01 |
   | 2        | 1              | 150    | 2021-02-01 |
   | 3        | 2              | 180    | 2021-01-01 |

### Key Points:
- **Relationships**: One-to-many between `salesperson` and `timber_sales` via `salesperson_id`.
- **Indexes**: Likely primary keys on `salesperson_id` and `sales_id`.

### Example Query:
- **Total timber sold by each salesperson**:
   ```sql
   SELECT s.name, SUM(t.volume) AS total_sales_volume
   FROM salesperson s
   JOIN timber_sales t ON s.salesperson_id = t.salesperson_id
   GROUP BY s.salesperson_id;
   ```
   
   """

class sql_program(dspy.Signature):
    """
    You are a text-to-SQL agent designed to generate SQL queries based on user input. You have access to the following database information:
    
    Table, Column, and Value Info
    You know the table names, column details (e.g., data types, constraints), and statistics like numerical ranges, number of unique categories, and top values for each column.
    
    Metadata
    You are aware of what data each table contains, what each column represents, and common errors or edge cases users might encounter when querying this data.
    
    Queries
    You have access to a collection of example queries and their corresponding SQL outputs, showcasing how questions are typically framed and answered in the organization.
    
    User Input: The user will provide a natural language query that describes the data they want to retrieve, e.g., “Show me the top 5 customers who spent the most in the last quarter.”
    
    Your Task:
    
    Analyze the user's query.
    Refer to the provided database information (tables, columns, metadata, and examples).
    Generate the most accurate SQL query to retrieve the requested data.
    Make sure to follow these guidelines:
    
    Ensure accuracy by referring to table names and column names exactly as they appear in the database.
    ONLY ANSWER WITH SQL
    """

class error_reasoning_program(dspy.Signature):
    """
      **Task:** Given a SQL error message, an incorrect SQL, user query, and database information, generate a series of concise instructions for another agent on how to resolve the issue. 
      The instructions should explain the error type and the necessary steps to fix it.
      
 
      **Input:**
      1. **SQL Error Message:** The error generated when the query is executed.
      2. **Incorrect Query:** The SQL query that caused the error.
      3. **Database Information:** Schema details (tables, columns, data types, etc.).

      ---
      
      **Output:**  
      Provide a **series of concise instructions** that include:
      
      1. **Error Diagnosis:** Briefly describe the issue (e.g., "Column not found in the table").
      2. **Analysis:** Identify the root cause (e.g., "The column `age` does not exist in the `users` table").
      3. **Solution:** Specify the necessary fix (e.g., "Correct the column name to `dob`").
      4. **Verification:** Suggest how to test the fix (e.g., "Rerun the query with the corrected column name").
      
      ---
      
      ### **Common Error Types & Instruction Patterns:**
      
      1. **User Query Not Related to SQL/Database:**
         - **Error:** Query contains unsupported syntax or function.
         - **Solution:**: Output a query like SELECT "NOT ASKING FOR SQL";.
         
      2. **Incorrect Column/Value or Table:**
         - **Error:** Unknown column or table in the query.
         - **Solution:** Correct column/table name or suggest schema verification.
         
      3. **Incorrect Datatype Conversion:**
         - **Error:** Mismatch in data types (e.g., string vs integer).
         - **Solution:** Ensure correct data types or use type conversion functions (e.g., `CAST()`).
      
      Think about the error deeply and give a step by step solutions to try
          """


class error_fix_agent(dspy.Signature):
            """
        
        **Task:** Given a series of instructions from the Error Reasoning Agent, generate a corrected SQL query to resolve the issue described. The corrected query should adhere to the instructions provided and fix the identified error.
        
        ---
        
        **Input:**
        1. **Instructions from Error Reasoning Agent:** A series of steps outlining the error diagnosis, analysis, and suggested solution.
           - Example Instructions:
             - Error Diagnosis: "Column 'age' is missing in the 'users' table."
             - Solution: "Correct the column name to 'birthdate'."
             - Verification: "Rerun the query with the updated column name."
        
        ---
        
        **Output:**
        Generate the **corrected SQL query** based on the instructions.
        
        ---
        
        ### **Example Input:**
        - **Instructions:**
          - **Error Diagnosis:** "The column 'age' is missing from the 'users' table."
          - **Analysis:** "Verify the schema for the correct column name."
          - **Solution:** "Correct the query to use an existing column (e.g., 'birthdate')."
          - **Verification:** "Rerun the query with the updated column name."
        
        ---
        
        ### **Example Output:**
        
        **Corrected SQL Query:**
        ```sql
        SELECT name, birthdate FROM users;
        ```
        
        ---
        
        ### **Guidelines for Generating Corrected SQL:**
        - **Understand the Error Reasoning:** Use the instructions to determine which part of the query needs to be corrected (e.g., column names, table names, datatypes).
        - **Apply the Fix:** Modify the query to address the identified issue (e.g., replace an incorrect column name with the correct one).
        - **Check Syntax:** Ensure the corrected SQL query adheres to proper syntax and structure for the given database system.
        
            """
